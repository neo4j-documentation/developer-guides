= Neo4j and GraphQL
:doctype: book
:level: Beginner
:page-level: Beginner
:author: Will Lyon
:category: integrations
:tags: labs, graphql, queries, grandstack, react, apollo, javascript, java
:page-pagination:
:page-newsletter: true

[#about-graphql]
image::https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/GraphQL_Logo.svg/200px-GraphQL_Logo.svg.png[float=right,width=200]

GraphQL is a specification for an API query language and a runtime for fulfilling these queries. GraphQL models application data as a graph and allows API clients to query the data as a graph irrespective of how the data is stored in the backend. While not specific to graph databases, using GraphQL with Neo4j offers several advantages including a consistent graph data model, increased developer productivity, and performance benefits.

== GraphQL Overview

GraphQL is fundamentally an API query language, as explained on the https://graphql.org/[GraphQL landing page^]:

> GraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.

A GraphQL query includes an entry point (a Query or Mutation field in GraphQL parlance), arguments, and a _selection set._ The selection set specifies a nested traversal through the data graph as well as which fields to be returned.

Let's look at a example GraphQL query:

.GraphQL example query
[source,graphql]
----
{
  movies(where: { title: "Matrix, The" }) {
    title
    plot
    year
    actors {
      name
    }
  }
}

----

The response to this query is a JSON object which matches the shape of the query - only the data requested by the client is returned.

.GraphQL example result
[source,json]
----
{
  "data": {
    "movies": [
      {
        "title": "Matrix, The",
        "plot": "A computer hacker learns from mysterious rebels about the true nature of his reality and his role in the war against its controllers.",
        "year": 1999,
        "actors": [
          {
            "name": "Hugo Weaving"
          },
          {
            "name": "Laurence Fishburne"
          },
          {
            "name": "Keanu Reeves"
          },
          {
            "name": "Carrie-Anne Moss"
          }
        ]
      }
    ]
  }
}
----


The typical approach to building a GraphQL API involves creating GraphQL _type definitions_ which define the data available in the API and how they are connected, and writing GraphQL _resolver functions_ which contain the logic for "resolving" data from the data layer. These type definitions and resolver functions are then combined into an executable GraphQL schema which can be served over HTTP.

GraphQL type definitions are typically defined using the GraphQL Schema Definition Language (SDL). SDL is a language-agnostic way The GraphQL type definitions for the example queries above would look like this in SDL:

.GraphQL example schema
[source,graphql]
----
type Movie {
  title: String!
   year: Int
   plot: String
   actors: [Person]
}

type Person {
   name: String!
   movies: [Movie]
}
----

The typical approach of writing GraphQL resolver functions manually can often involve lots of boilerplate code. Fortunately, we can often leverage tools like Neo4j's OGM and Spring Data integration when building GraphQL APIs as described in https://info.michael-simons.eu/2021/07/13/neo4j-java-and-graphql/[this blog post.^]

For further enhanced developer productivity the Neo4j GraphQL Library can be used to build GraphQL APIs backed by Neo4j driven by GraphQL type definitions.

== The Neo4j GraphQL Library

image::https://dist.neo4j.com/wp-content/uploads/20210423155831/graphql-diagram.svg[]

The Neo4j GraphQL Library is a JavaScript library that can be used with any JavaScript GraphQL implementation, such as Apollo Server.

Features of the Neo4j GraphQL Library include:

* TODO: add features with link to relevant docs page

=== Using The Neo4j GraphQL Library With Neo4j Aura

Let's see how we can create a simple GraphQL API using the Neo4j GraphQL Library and Neo4j Aura. We'll be creating a Node.js GraphQL API application that will use the Neo4j GraphQL Library and Apollo Server to create 

First, in a new directory we'll create a new Node.js project:

....
npm init -y
....

And install the necessary dependencies:

....
npm install @neo4j/graphql neo4j-driver graphql apollo-server dotenv
....

Next, we'll provision a Neo4j Aura instance. We'll use the free-tier of Neo4j Aura so we won't need to put in a credit card or incur any costs. Log in to https://dev.neo4j.com/aura[Neo4j Aura^] and select "Create Free DB".

image::https://dist.neo4j.com/wp-content/uploads/20210826145910/neo4j-aura-free.png[]

A random password for your Neo4j Aura instance will be generated, be sure to save this somewhere as we'll need to use it to access our Neo4j database. 

image::https://dist.neo4j.com/wp-content/uploads/20210826150418/neo4j-aura-password.png[]

Provisioning our Neo4j Aura instance will take a few moments. Once it is ready in the Neo4j Aura dashboard we'll see the connection URI, which we'll need to connect our GraphQL API to Neo4j Aura.

image::https://dist.neo4j.com/wp-content/uploads/20210826151045/neo4j-aura-dashboard.png[]

Next, create a new file `.env` with the connection credentials for our Neo4j Aura instance. This will allow us to set our connection details in environment variables, without mixing these secrets in our code. Here's what my `.env` file looks like, but be sure to replace with your own connection credentials for your Neo4j Aura instance

.`.env`
[source,md]
----
NEO4J_USER=neo4j
NEO4J_PASSWORD=a2y4FVUlfPdDPzU5EUeEq-arDdyokWStO1m7wlkY8u4
NEO4J_URI=neo4j+s://80be87a6.databases.neo4j.io
----

Let's reuse our movie and actor GraphQL type definitions from above and use them with the Neo4j GraphQL Library:

.`index.js`
[source,JavaScript]
----
const { gql, ApolloServer } = require("apollo-server");
const { Neo4jGraphQL } = require("@neo4j/graphql");
const neo4j = require("neo4j-driver");
require("dotenv").config();

const typeDefs = gql`
  type Movie {
    title: String!
    year: Int
    plot: String
    actors: [Person] @relationship(type: "ACTED_IN", direction: IN)
  }

  type Person {
    name: String!
    movies: [Movie] @relationship(type: "ACTED_IN", direction: OUT)
  }
`;

const driver = neo4j.driver(
  process.env.NEO4J_URI,
  neo4j.auth.basic(process.env.NEO4J_USER, process.env.NEO4J_PASSWORD)
);

const neoSchema = new Neo4jGraphQL({ typeDefs, driver });

const server = new ApolloServer({
  schema: neoSchema.schema,
});

server.listen().then(({ url }) => {
  console.log(`GraphQL server ready on ${url}`);
});
----

TODO: mutation to create movie, what that looks like in neo4j browser and querying using filter

TODO: next step CTA - graph academy


[#graphql-resources]
== Resources
* https://neo4j.com/product/graphql-library/[The Neo4j GraphQL Library overview page^]
* https://neo4j.com/docs/graphql-manual/current/[Neo4j GraphQL Library Documentation^]
* GraphAcademy Course: https://neo4j.com/graphacademy/training-graphql-apis/enrollment/[Building GraphQL APIs With The Neo4j GraphQL Library^]
* Book: https://www.manning.com/books/fullstack-graphql-applications[Full Stack GraphQL Applications With React, Node.js, and Neo4j]^
